name: Test SQL Server Connection (Local) and Python

on:
  workflow_dispatch:

jobs:
  test-connection-pwsh:
    name: Test SQL Connection with PowerShell
    runs-on: self-hosted

    env:
      SQL_SERVER: ${{ secrets.SQL_SERVER }}
      SQL_DATABASE: ${{ secrets.SQL_DATABASE }}

    steps:
      - name: Test SQL Server Connection with sqlcmd
        shell: pwsh
        run: |
          Write-Host "Testing connection to SQL Server at $env:SQL_SERVER..."
          try {
            sqlcmd -S $env:SQL_SERVER -d $env:SQL_DATABASE -E -Q "SELECT @@SERVERNAME AS [ServerName];"
            Write-Host "Connection succeeded to the SQL Database."
          } catch {
            Write-Error "Connection failed. Error: $_"
            exit 1
          }

  test-python-conda:
    name: Hello from Python (Conda)
    runs-on: self-hosted

    steps:
      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: 'latest'
          auto-activate-base: false

      - name: Install packages from requirements.txt
        run: conda run -n RetailPulse_DW pip install --ignore-installed -r requirements.txt

      - name: Run Hello World from Conda env
        run: conda run -n RetailPulse_DW python -c "print('âœ… Hello, world from Conda env!')"
