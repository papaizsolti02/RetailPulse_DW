name: Test SQL Server Connection (Local) and Python

on:
  workflow_dispatch:

jobs:
  test-connection-pwsh:
    name: Test SQL Connection with PowerShell
    runs-on: self-hosted

    env:
      SQL_SERVER: ${{ secrets.SQL_SERVER }}
      SQL_DATABASE: ${{ secrets.SQL_DATABASE }}

    steps:
      - name: Test SQL Server Connection with sqlcmd
        shell: pwsh
        run: |
          Write-Host "Testing connection to SQL Server at $env:SQL_SERVER..."
          try {
            sqlcmd -S $env:SQL_SERVER -d $env:SQL_DATABASE -E -Q "SELECT @@SERVERNAME AS [ServerName];"
            Write-Host "Connection succeeded to the SQL Database."
          } catch {
            Write-Error "Connection failed. Error: $_"
            exit 1
          }

  test-python-conda:
    name: Hello from Python (Conda)
    runs-on: self-hosted

    steps:
      - name: Set up Python 3.11.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11.11'

      - name: Install dependencies from requirements.txt
        run: |
          python -m pip install --upgrade pip
          pip install --ignore-installed -r requirements.txt

      - name: Run Hello World from Python
        run: |
          python -c "print('Hello, world from Python 3.11.11!')"
